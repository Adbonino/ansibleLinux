---
- name: Procesar entidades JSON desde un archivo
  hosts: localhost
  gather_facts: no
  vars:
    json_file: "vms.json"

  tasks:
    - name: Leer archivo JSON
      slurp:
        src: "{{ json_file }}"
      register: json_file_content

    - name: Convertir contenido a diccionario
      set_fact:
        entities_data: "{{ json_file_content.content | b64decode | from_json }}"
    
    - name: Crear lista de nombres de VMs y sus direcciones IP
      set_fact:
        vm_info: []

    - name: Agregar vm_name a la lista
      set_fact:
        vm_info: "{{ vm_info | default([]) + [{'vm_name': vm_name}] }}"
      with_items: "{{ entities_data.msg.json.group_results[0].entity_results }}"
      vars:
        vm_name: >-
          {%- set result = item.data | selectattr('name', 'equalto', 'vm_name') | first -%}
          {{ result.values[0].values[0] if result is defined and result.values | length > 0 else None }}
      when: vm_name is not none
    
    - name: Mostrar lista de nombres de VMs
      debug:
        msg: "{{ vm_info }}"
