- name: Crear Usuario
  hosts: all
  become: yes
  vars:
    path_salida: "/tmp/crear_user.tml"
  
  tasks:
    - name: Obtener información del sistema
      command: cat /etc/os-release
      register: os_release
    
    - lineinfile:
        path: "{{ path_salida }}"
        line: "SISTEMA OPERATIVO: {{ os_release }}"
        create: yes
        state: present

    - name: Verificar la distribución
      set_fact:
        is_redhat: "{{ 'Red Hat' in os_release.stdout or 'CentOS' in os_release.stdout or 'Fedora' in os_release.stdout }}"
        is_debian: "{{ 'Ubuntu' in os_release.stdout or 'Debian' in os_release.stdout }}"

    - name: Generar hash de la contraseña con openssl
      command: "openssl passwd -1 '{{ password }}'"
      register: hashed_password_output
      delegate_to: localhost

    - lineinfile:
        path: "{{ path_salida }}"
        line: >
          Generacion de Hash:
          {% if hashed_password_output.rc == 0 %}
          OK.
          {% else %}
          {{ hashed_password_output.rc }}.
          {% endif %}
        create: yes
        state: present
      delegate_to: localhost

    - name: Mostrar Hash
      debug: 
        msg: "{{ hashed_password_output.stdout }}"
      delegate_to: localhost

    - name: Crear el usuario si no existe
      user:
        name: "{{ nombre_de_usuario }}"
        password: "{{ hashed_password_output.stdout }}"
        state: present
      register: creacion_user

    - name: mostrar
      debug:
        msg: "{{ creacion_user }}"

    - lineinfile:
        path: "{{ path_salida }}"
        line: >
          Creacion del usurio {{nombre_de_usuario}}:
          {% if creacion_user.rc == 0 %}
          OK.
          {% else %}
          {{ creacion_user.rc }}.
          {% endif %}
        create: yes
        state: present
      delegate_to: localhost

    - name: enviar correo
      include_tasks: enviar_Salida.yml
       
  
  